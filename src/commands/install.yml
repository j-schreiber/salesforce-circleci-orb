description: >
  Downloads and installs the latest SFDX and SF CLI version from the official Salesforce channels.

parameters:
  sfdxCliVersion:
    description: Environment variable that holds the package version that should be installed.
      If empty or the variable does not exist, installs the latest version.
    default: SFDX_CLI_VERSION
    type: env_var_name

steps:
  - run:
      environment:
        PARAM_REQUESTED_CLI_VERSION: << parameters.sfdxCliVersion >>
      name: Install Latest CLI
      command: <<include(scripts/install-cli.sh)>>
  - run:
      name: Verify CLI Installation
      command: |
        sfdx version
        sf version
  - run:
      name: Install TMH SF CLI Plugin
      command: |
        mkdir -p $HOME/.config/sf
        echo '["@tmh-bis-salesforce/tmh-bis-salesforce-cli-plugin"]' > $HOME/.config/sf/unsignedPluginAllowList.json
        sf plugins install @tmh-bis-salesforce/tmh-bis-salesforce-cli-plugin
  - run:
      name: Verify TMH SF CLI Plugin Installation
      command: |
        IS_SUPPORTED=$(sf doctor --json | jq '.result.pluginSpecificData."@tmh-bis-salesforce/tmh-bis-salesforce-cli-plugin"[0].isSupportedCliVersion')
        if [ ! $IS_SUPPORTED ]; then
            echo 'Salesforce CLI version does not fulfill plugin requirements.'
            exit 1
        elif [ $IS_SUPPORTED = "null" ]; then
            echo 'TMH Salesforce CLI plugin not installed.'
            exit 1
        fi
        echo 'TMH Salesforce CLI plugin installed and ready to use.'
